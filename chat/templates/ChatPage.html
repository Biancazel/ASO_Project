<!DOCTYPE html>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<style>
    #id_chat_item_container{
        font-size: 20px;
    }
    #id_message_box{
        border: 2px solid black;

    }
</style>
<html>
  <body style="background: beige">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark"><a class="navbar-brand" href="#" style="font-family: 'Book Antiqua'">Chatroom</a>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item">
          {% if request.user.is_authenticated  %}
        <a class="nav-link" href="{% url 'logout-user' %}" style="font-family: 'Book Antiqua'">Logout</a>
            {% endif %}
      </li>
    </ul>
  </div>
</nav>
    <div
      class="chat__item__container"
      id="id_chat_item_container"
    >
        <section style="background-color: #eee">
         <div class="row d-flex justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-4">
                <div class="card" id="chat1" style="border-radius: 15px;">
                    <div
                        class="card-header d-flex justify-content-between align-items-center p-3 bg-info text-white border-bottom-0"
                            style="border-top-left-radius: 15px; border-top-right-radius: 15px;">
                        <i class="fas fa-angle-left"></i>
                        <p class="mb-0 fw-bold">Live chat</p>
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="card-body" id="id_message_container">
                     {% for message in latest_messages_list %}
                        {% if message.is_image == 1 %}
                            {% if request.user.username == message.owner %}
                            <div class="d-flex flex-row justify-content-start mb-4">
                            {{ message.owner }}
                                <div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                                <img src = "{{ message.content }}" style="width:200px;height:200px"/></div>
                            </div>
                            {% else %}
                                 <div class="d-flex flex-row justify-content-end mb-4">

                                <div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                                <img src = "{{ message.content }}" style="width:200px;height:200px"/></div>
                                 {{ message.owner }}
                                 </div>

                            {% endif %}
                        {% else %}
                             {% if request.user.username == message.owner %}
                            <div class="d-flex flex-row justify-content-start mb-4">
                            {{ message.owner }}
                                <div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                                {{ message.content }}
                                </div>
                            </div>
                            {% else %}
                                 <div class="d-flex flex-row justify-content-end mb-4">

                                <div class="p-3 ms-3" style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                                {{ message.content }}
                                </div>
                                 {{ message.owner }}
                                 </div>

                            {% endif %}

                        {% endif %}
                     {% endfor %}
                    </div>
            </div>
          </div>
        <div class="form-outline" style="text-align: center; width: 100%">
            <div style="text-align: left; width: 80%; display: inline-block;">
            <div id="id_typing_container" style="display: block; margin: 0 auto; text-align: center"></div>
                <input class="form-control align-items-center" type="text" style="width: 50%; display: block; margin: 0 auto;" id="id_message_send_input">
            <button type="submit" id="id_message_send_button" class="btn btn-dark btn-block mb-4" style="display: block; margin: 0 auto;">Send</button>
            </div>

<form id="id_upload_form" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          {{form.as_p}}
          <button class="btn btn-dark my-4" type="submit">Upload</button>
        <button id="id_button_upload" type="button">Send Image</button> <span>{{ image }}</span>
      </form>
        </div>

        </section>
    </div>

    <script>
      let isSendingText = false;
      const chatSocket = new WebSocket("ws://" + window.location.host + "/");
      chatSocket.onopen = function (e) {
        console.log("The connection was setup successfully !");
      };
      chatSocket.onclose = function (e) {
        console.log("Something unexpected happened !");
      };

      document.querySelector("#id_message_send_input").focus();
      document.querySelector("#id_message_send_input").onkeyup = function (e) {
          const writingText = "User {{ request.user.username }} is typing..."
        chatSocket.send(JSON.stringify({message: writingText, username: "{{ request.user.username }}", is_writing_data: true, image: null}))
        if (e.keyCode == 13) {
          document.querySelector("#id_message_send_button").click();
        }
      };

      document.querySelector("#id_message_send_button").onclick = function (e) {
          isWritingText = false;
          isSendingText = true;
        var messageInput = document.querySelector(
          "#id_message_send_input"
        ).value;
        chatSocket.send(JSON.stringify({ message: messageInput, username : "{{request.user.username}}", is_writing_data: false, image: null}));
      };

      document.querySelector("#id_button_upload").onclick = function(e) {
          if("{{ image }}" !== "None") {
              chatSocket.send(JSON.stringify({
                  message: '',
                  username: '{{request.user.username}}',
                  is_writing_data: false,
                  image: '{{image}}'
              }))
          }
      }

      chatSocket.onmessage = function (e) {

        const data = JSON.parse(e.data);
        if(data.is_writing_data === false) {
            if(data.image === null) {
                var div = document.createElement("div");
                if(data.username === "{{ request.user.username }}"){
                    div.className = "d-flex flex-row justify-content-start mb-4";
                    div.innerHTML = data.username;
                    var bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "p-3 ms-3";
                    bubbleDiv.style.borderRadius = "15px";
                    bubbleDiv.style.backgroundColor = "rgba(57, 192, 237,.2)";
                    bubbleDiv.innerHTML = data.message;
                    var p = document.createElement("p");
                    p.className = "small mb-0";
                    bubbleDiv.appendChild(p);
                    div.appendChild(bubbleDiv);

                }
                else {
                    div.className = "d-flex flex-row justify-content-end mb-4";
                    var bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "p-3 ms-3";
                    bubbleDiv.style.borderRadius = "15px";
                    bubbleDiv.style.backgroundColor = "rgba(57, 192, 237,.2)";
                    bubbleDiv.innerHTML = data.message;
                    var p = document.createElement("p");
                    p.className = "small mb-0";
                    bubbleDiv.appendChild(p);
                    div.appendChild(bubbleDiv);
                    div.innerHTML += data.username;
                }
                document.querySelector("#id_message_send_input").value = "";
                document.querySelector("#id_message_container").appendChild(div);
            }
            else {
                var div = document.createElement("div");
                if(data.username === "{{ request.user.username }}"){
                    div.className = "d-flex flex-row justify-content-start mb-4";
                    div.innerHTML = data.username;
                    var bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "p-3 ms-3";
                    bubbleDiv.style.borderRadius = "15px";
                    bubbleDiv.style.backgroundColor = "rgba(57, 192, 237,.2)";
                    bubbleDiv.innerHTML = data.message;
                    var img = document.createElement("img");
                    img.src = data.image;
                    img.style.width = "200px";
                    img.style.height = "200px";
                    bubbleDiv.appendChild(img);
                    div.appendChild(bubbleDiv);
                }
                else {
                    div.className = "d-flex flex-row justify-content-end mb-4";
                    var bubbleDiv = document.createElement("div");
                    bubbleDiv.className = "p-3 ms-3";
                    bubbleDiv.style.borderRadius = "15px";
                    bubbleDiv.style.backgroundColor = "rgba(57, 192, 237,.2)";
                    bubbleDiv.innerHTML = data.message;
                    var img = document.createElement("img");
                    img.src = data.image;
                    img.style.width = "200px";
                    img.style.height = "200px";
                    bubbleDiv.appendChild(img);
                    div.appendChild(bubbleDiv);
                    div.innerHTML += data.username;
                }
                document.querySelector("#id_message_container").appendChild(div);
            }
        }
        else {
            const duration = 1500; //ms
            if("{{ request.user.username }}" !== data.username) {
                document.querySelector("#id_typing_container").innerHTML = data.message;
                setTimeout(
                    function () {
                        document.querySelector("#id_typing_container").innerHTML = "";
                    }, duration);
            }

        }
      };
    </script>
  </body>
</html>